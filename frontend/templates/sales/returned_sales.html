{% extends "base.html" %}

{% block title %}Returned Orders{% endblock %}

{% block content %}
<div class="container-fluid py-2 px-3">
<style>
.page-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    flex-wrap: wrap;
    gap: 12px;
    margin-bottom: 18px;
}
.page-header h1 {
    font-size: 1.25rem;
    font-weight: 700;
    margin: 0;
}
.page-header p {
    font-size: 0.8rem;
    color: var(--text-muted);
    margin: 0;
}
.filter-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    margin-bottom: 14px;
    box-shadow: 0 2px 8px rgba(15,23,42,0.05);
}
.filter-card label {
    font-size: 0.72rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-muted);
    margin-bottom: 4px;
    display: block;
}
.filter-card .form-control,
.filter-card .form-select {
    font-size: 0.85rem;
    padding: 6px 10px;
    border-radius: 8px;
}
.data-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(15,23,42,0.05);
}
.data-card table {
    margin: 0;
    font-size: 0.85rem;
}
.data-card thead th {
    background: var(--surface-muted);
    border-bottom: 1px solid var(--border);
    font-size: 0.72rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    color: var(--text-muted);
    padding: 10px 14px;
    white-space: nowrap;
}
.data-card tbody td {
    padding: 10px 14px;
    vertical-align: middle;
    border-bottom: 1px solid var(--border);
}
.data-card tbody tr:last-child td {
    border-bottom: none;
}
.data-card tbody tr:hover td {
    background: #fafbff;
}
.sale-number {
    font-family: monospace;
    font-size: 0.8rem;
    color: var(--brand-dark);
    font-weight: 600;
}
.sale-date {
    font-size: 0.8rem;
    color: var(--text-muted);
    white-space: nowrap;
}
.action-group {
    display: flex;
    flex-wrap: wrap;
    gap: 4px;
}
.action-group .btn {
    font-size: 0.75rem;
    padding: 3px 10px;
    border-radius: 6px;
    white-space: nowrap;
}
.returned-indicator {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 0.75rem;
    font-weight: 600;
    color: #64748b;
    background: #f1f5f9;
    border: 1px solid #e2e8f0;
    border-radius: 999px;
    padding: 2px 10px;
}
.empty-state {
    text-align: center;
    padding: 52px 20px;
    color: var(--text-muted);
}
.empty-state svg {
    display: block;
    margin: 0 auto 14px;
    opacity: 0.2;
}
.empty-state p { margin: 0; font-size: 0.95rem; }
.empty-state .sub { font-size: 0.8rem; margin-top: 4px; }
</style>

<!-- Header -->
<div class="page-header">
    <div>
        <h1>Returned Orders</h1>
        <p>All refunded or returned orders with inventory restored.</p>
    </div>
    <a href="/sales/history/" class="btn btn-outline-secondary btn-sm px-3">Sales History</a>
</div>

<!-- Filters -->
<div class="filter-card">
    <form method="get">
        <div class="row g-2 align-items-end">
            <div class="col-sm-3">
                <label>Filter by</label>
                <select name="filter_by" class="form-select">
                    <option value="all"            {% if filter_by == 'all' %}selected{% endif %}>All</option>
                    <option value="customer"       {% if filter_by == 'customer' %}selected{% endif %}>Customer Name</option>
                    <option value="phone"          {% if filter_by == 'phone' %}selected{% endif %}>Customer Phone</option>
                    <option value="sale_number"    {% if filter_by == 'sale_number' %}selected{% endif %}>Sale Number</option>
                    <option value="amount"         {% if filter_by == 'amount' %}selected{% endif %}>Total Amount</option>
                    <option value="payment_method" {% if filter_by == 'payment_method' %}selected{% endif %}>Payment Method</option>
                </select>
            </div>
            <div class="col-sm-4">
                <label>Search</label>
                <input type="text" name="q" class="form-control" value="{{ query|default:'' }}" placeholder="Type here…">
            </div>
            <div class="col-sm-3">
                <label>Sort by</label>
                <select name="sort_by" class="form-select">
                    <option value="date_desc"    {% if sort_by == 'date_desc' %}selected{% endif %}>Date (Newest)</option>
                    <option value="date_asc"     {% if sort_by == 'date_asc' %}selected{% endif %}>Date (Oldest)</option>
                    <option value="customer_asc" {% if sort_by == 'customer_asc' %}selected{% endif %}>Customer A→Z</option>
                    <option value="customer_desc"{% if sort_by == 'customer_desc' %}selected{% endif %}>Customer Z→A</option>
                    <option value="amount_asc"   {% if sort_by == 'amount_asc' %}selected{% endif %}>Amount Low→High</option>
                    <option value="amount_desc"  {% if sort_by == 'amount_desc' %}selected{% endif %}>Amount High→Low</option>
                </select>
            </div>
            <div class="col-sm-2 d-flex gap-2 align-items-end">
                <button type="submit" class="btn btn-primary btn-sm px-3">Apply</button>
                <a href="/sales/returns/" class="btn btn-outline-secondary btn-sm px-3">Reset</a>
            </div>
        </div>
    </form>
</div>

<!-- Table -->
<div class="data-card">
    {% if sales %}
    <div class="table-responsive">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Sale #</th>
                    <th>Date</th>
                    <th>Customer</th>
                    <th>Total</th>
                    <th>Payment</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for sale in sales %}
                <tr>
                    <td><span class="sale-number">{{ sale.sale_number }}</span></td>
                    <td><span class="sale-date">{{ sale.sale_date|date:"M d, Y" }}<br><small>{{ sale.sale_date|date:"H:i" }}</small></span></td>
                    <td>
                        {% if sale.irregular_customer %}
                            <span class="text-muted" style="font-size:0.78rem;">Walk-in</span><br>
                            {{ sale.irregular_customer.customer_name }}
                        {% else %}
                            {{ sale.customer.customer_name|default:"—" }}
                        {% endif %}
                    </td>
                    <td><strong>Rs. {{ sale.total_amount }}</strong></td>
                    <td>
                        {% if sale.payment_method == 'cash' %}
                            <span class="badge bg-secondary">Cash</span>
                        {% elif sale.payment_method == 'card' %}
                            <span class="badge bg-info text-dark">QR</span>
                        {% elif sale.payment_method == 'credit' %}
                            <span class="badge bg-warning text-dark">Credit</span>
                        {% else %}
                            <span class="badge bg-light text-dark">{{ sale.payment_method }}</span>
                        {% endif %}
                    </td>
                    <td><span class="returned-indicator">Returned</span></td>
                    <td>
                        <div class="action-group">
                            <a href="/sales/{{ sale.sale_number }}/" class="btn btn-sm btn-outline-secondary">View</a>
                            <a href="/sales/receipt/{{ sale.sale_number }}/" class="btn btn-sm btn-outline-success" target="_blank" rel="noopener">Receipt</a>
                            <a href="/sales/receipt/{{ sale.sale_number }}/pdf/?download=1" class="btn btn-sm btn-outline-primary" target="_blank" rel="noopener" download>PDF</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <svg width="52" height="52" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.2">
            <polyline points="1 4 1 10 7 10"/>
            <path d="M3.51 15a9 9 0 1 0 .49-3.5"/>
        </svg>
        <p>No returned orders</p>
        <p class="sub">Returned orders will appear here once processed.</p>
    </div>
    {% endif %}
</div>

</div>
{% endblock %}
