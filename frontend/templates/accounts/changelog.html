{% extends "base.html" %}
{% block title %}Changelog{% endblock %}
{% block content %}
<div class="container-fluid py-2 px-3">
<style>
.page-header { display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:12px; margin-bottom:18px; }
.page-header h1 { font-size:1.25rem; font-weight:700; margin:0; }
.page-header p { font-size:0.8rem; color:var(--text-muted); margin:0; }
.data-card { background:var(--surface); border:1px solid var(--border); border-radius:14px; overflow:hidden; box-shadow:0 2px 8px rgba(15,23,42,0.05); margin-bottom:8px; }
.log-header { display:flex; align-items:flex-start; gap:12px; padding:12px 16px; cursor:pointer; user-select:none; }
.log-header:hover { background:#f8fafc; }
.log-time { font-size:0.78rem; color:var(--text-muted); white-space:nowrap; min-width:80px; }
.log-meta { flex:1; display:flex; align-items:center; gap:8px; flex-wrap:wrap; }
.log-desc { font-size:0.83rem; color:#475569; flex-basis:100%; margin-top:2px; }
.log-record { font-family:monospace; font-size:0.78rem; color:var(--brand); }
.expand-btn { font-size:0.7rem; color:var(--text-muted); white-space:nowrap; padding-top:2px; }
.diff-body { border-top:1px solid var(--border); padding:14px 16px; background:#fafbff; display:none; }
.diff-body.open { display:block; }
.diff-table { width:100%; border-collapse:collapse; font-size:0.82rem; }
.diff-table th { font-size:0.7rem; font-weight:700; text-transform:uppercase; letter-spacing:0.04em; color:var(--text-muted); padding:6px 10px; text-align:left; border-bottom:1px solid var(--border); background:#f1f5f9; }
.diff-table td { padding:7px 10px; border-bottom:1px solid #f1f5f9; vertical-align:top; }
.diff-table tr:last-child td { border-bottom:none; }
.diff-field { font-weight:600; color:#334155; }
.val-before { color:#dc2626; background:#fef2f2; border-radius:4px; padding:1px 7px; font-size:0.82rem; }
.val-after { color:#16a34a; background:#f0fdf4; border-radius:4px; padding:1px 7px; font-size:0.82rem; }
.diff-arrow { color:#94a3b8; font-size:0.9rem; }
.no-diff { font-size:0.8rem; color:var(--text-muted); font-style:italic; margin:0; }
.empty-state { text-align:center; padding:52px 20px; color:var(--text-muted); }
</style>

<div class="page-header">
    <div>
        <h1>Changelog</h1>
        <p>Record of all staff modifications — last 500 entries. Click a row to see what changed.</p>
    </div>
    <a href="{% url 'staff_list' %}" class="btn btn-outline-secondary btn-sm px-3">Staff Accounts</a>
</div>

{% if logs %}
{% for entry in logs %}
<div class="data-card">
    <div class="log-header" onclick="toggleDiff(this)">
        <div class="log-time">
            {{ entry.log.timestamp|date:"M d, Y" }}<br>
            <small>{{ entry.log.timestamp|date:"H:i:s" }}</small>
        </div>
        <div class="log-meta">
            <strong style="font-size:0.88rem;">{{ entry.log.username }}</strong>
            {% if entry.log.action == 'create' %}
                <span class="badge bg-success">Created</span>
            {% elif entry.log.action == 'update' %}
                <span class="badge bg-warning text-dark">Updated</span>
            {% elif entry.log.action == 'delete' %}
                <span class="badge bg-danger">Deleted</span>
            {% else %}
                <span class="badge bg-secondary">{{ entry.log.action }}</span>
            {% endif %}
            <span style="font-size:0.78rem; color:var(--text-muted);">{{ entry.log.model_name }}</span>
            <span class="log-record">{{ entry.log.record_id }}</span>
            <span class="log-desc">{{ entry.log.description }}</span>
        </div>
        <span class="expand-btn">{% if entry.diff %}▼ details{% else %}▼{% endif %}</span>
    </div>
    <div class="diff-body">
        {% if entry.diff %}
        <table class="diff-table">
            <thead>
                <tr>
                    <th style="width:150px;">Field</th>
                    <th>Before</th>
                    <th style="width:28px; text-align:center;"> </th>
                    <th>After</th>
                </tr>
            </thead>
            <tbody>
                {% for change in entry.diff %}
                <tr>
                    <td class="diff-field">{{ change.field }}</td>
                    <td><span class="val-before">{{ change.before|default:"—" }}</span></td>
                    <td class="diff-arrow" style="text-align:center;">→</td>
                    <td><span class="val-after">{{ change.after|default:"—" }}</span></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="no-diff">{{ entry.log.description }}</p>
        {% endif %}
    </div>
</div>
{% endfor %}
{% else %}
<div class="data-card">
    <div class="empty-state">
        <p>No changelog entries yet.</p>
        <p style="font-size:0.8rem; margin-top:4px;">Changes made by staff will appear here.</p>
    </div>
</div>
{% endif %}

</div>
<script>
function toggleDiff(header) {
    var body = header.nextElementSibling;
    var btn = header.querySelector('.expand-btn');
    var isOpen = body.classList.toggle('open');
    var hasDiff = btn.textContent.indexOf('details') !== -1;
    btn.textContent = isOpen ? (hasDiff ? '▲ details' : '▲') : (hasDiff ? '▼ details' : '▼');
}
</script>
{% endblock %}
